<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>المنظومة الوطنية للحصيلة الرقمية - الحماية المدنية</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<style>
:root { --primary:#1a237e; --accent:#c62828; --success:#2e7d32; --bg:#f4f7f9; }
body { font-family: 'Cairo', sans-serif; background: var(--bg); margin: 0; direction: rtl; }
.hidden { display: none !important; }
input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
.container { zoom: 90%; padding: 20px; width: 98%; margin: auto; background: white; min-height: 100vh; }

/* تصميم صفحة الدخول الوطنية */
#login-page { 
    background: linear-gradient(rgba(26, 35, 126, 0.9), rgba(13, 71, 161, 0.8)), url('https://www.mdn.dz/site_main/images/slider/pc/1.jpg'); 
    background-size: cover; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; 
}
.login-card { background: white; padding: 25px; border-radius: 25px; width: 350px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); text-align: center; }
.input-field { font-family: 'Cairo'; width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 10px; border: 2px solid #ddd; font-weight: 600; box-sizing: border-box; }

/* الجداول والخطوط */
table { width: 100%; border-collapse: collapse; border: 2.5px solid #000; }
th, td { border: 2px solid #000; padding: 8px; text-align: center; font-weight: 700; }
th { background: var(--primary); color: white; font-size: 15px; }
.editable { width: 90%; border: 1px solid #ccc; text-align: center; font-size: 18px; font-family: 'Cairo'; font-weight: 900; }
.btn { font-family: 'Cairo'; padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; color: white; transition: 0.3s; margin: 5px; }
</style>
</head>
<body>

<div id="login-page">
    <div style="text-align: center; color: white; margin-bottom: 20px;">
        <h1 style="font-size: 2.2rem; font-weight: 900;">الجمهورية الجزائرية الديمقراطية الشعبية</h1>
        <h2 style="color: #ffd700;">المنظومة الوطنية للحصيلة الرقمية</h2>
    </div>
    <div class="login-card">
        <label>اختر الولاية:</label>
        <select id="state-id" class="input-field" onchange="loadUnitsForState()">
            <option value="">-- اختر الولاية (01-58) --</option>
        </select>
        
        <label>الوحدة / المركز:</label>
        <select id="user-role" class="input-field"></select>
        
        <input type="password" id="pass-code" class="input-field" placeholder="كلمة المرور">
        <button onclick="login()" class="btn" style="background: var(--primary); width: 100%; font-size: 1.2rem;">دخول للمنظومة</button>
    </div>
</div>

<div id="app-content" class="hidden">
    <div class="container">
        <div id="setup-section" class="hidden no-print" style="background: #fff3e0; padding: 20px; border: 2px dashed #e67e22; border-radius: 15px; margin-bottom: 20px;">
            <h3 style="color: #e67e22;"><i class="fa-solid fa-gears"></i> إعدادات الولاية لأول مرة</h3>
            <p>بصفتك المتحكم الرئيسي، يرجى تعريف الوحدات والبلديات التابعة لولايتك:</p>
            <button onclick="setupStateConfig()" class="btn" style="background: #e67e22;">ضبط الوحدات والبلديات</button>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px;">
            <h2 id="display-state-name" style="margin:0; color: var(--primary);"></h2>
            <div id="user-tag" style="background: var(--accent); color:white; padding: 5px 15px; border-radius: 20px; font-weight: 900;"></div>
        </div>

        <div class="no-print" style="text-align:center; margin-bottom: 20px;">
            <input type="week" id="week-picker" class="input-field" style="width: 250px;" onchange="changeWeek()">
        </div>

        <table id="daily-table">
            <thead>
                <tr><th rowspan="2">التاريخ</th><th colspan="4">الإسعاف</th><th colspan="4">حوادث المرور</th><th colspan="4">الحرائق</th><th colspan="4">مختلفة</th><th rowspan="2">ع ت</th></tr>
                <tr style="background:#f0f0f0; color:black; font-size: 11px;">
                    <th>ع ع</th><th>ع ت</th><th>مسعف</th><th>وفاة</th>
                    <th>ع ع</th><th>ع ت</th><th>مسعف</th><th>وفاة</th>
                    <th>ع ع</th><th>ع ت</th><th>مسعف</th><th>وفاة</th>
                    <th>ع ع</th><th>ع ت</th><th>مسعف</th><th>وفاة</th>
                </tr>
            </thead>
            <tbody id="daily-body"></tbody>
            <tfoot id="daily-foot" style="background:#e8f5e9;"></tfoot>
        </table>

        <div style="margin-top: 30px; text-align: center;">
            <button class="btn" style="background:var(--success)" onclick="saveData()"><i class="fa-solid fa-cloud-arrow-up"></i> حفظ البيانات سحابياً</button>
            <button class="btn" style="background:#546e7a" onclick="location.reload()">خروج</button>
        </div>
    </div>
</div>

<script>
// --- إعدادات Firebase الجديدة للمشروع الوطني ---
const firebaseConfig = {
  apiKey: "AIzaSy...", 
  authDomain: "your-national-project.firebaseapp.com",
  databaseURL: "https://your-national-project.firebaseio.com",
  projectId: "your-national-project",
  storageBucket: "your-national-project.appspot.com",
  messagingSenderId: "...",
  appId: "..."
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const algeriaStates = ["أدرار","الشلف","الأغواط","أم البواقي","باتنة","بجاية","بسكرة","بشار","البليدة","البويرة","تمنراست","تبسة","تلمسان","تيارت","تيزي وزو","الجزائر","الجلفة","جيجل","سطيف","سعيدة","سكيكدة","سيدي بلعباس","عنابة","قالمة","قسنطينة","المدية","مستغانم","المسيلة","معسكر","ورقلة","وهران","البيض","إليزي","برج بوعريريج","الطارف","تندوف","تسمسيلت","الوادي","خنشلة","سوق أهراس","تيبازة","ميلة","عين الدفلى","النعامة","عين تموشنت","غرداية","غليزان","تيميمون","برج باجي مختار","أولاد جلال","بني عباس","إن صالح","إن قزام","تقرت","جانت","المغير","المنيعة"];

let currentStateId = "";
let currentUser = "";
let unitConfig = {}; 

window.onload = function() {
    const stateSelect = document.getElementById("state-id");
    algeriaStates.forEach((name, index) => {
        let code = (index + 1).toString().padStart(2, '0');
        stateSelect.innerHTML += `<option value="${code}">${code} - ${name}</option>`;
    });
};

async function loadUnitsForState() {
    currentStateId = document.getElementById("state-id").value;
    const unitSelect = document.getElementById("user-role");
    unitSelect.innerHTML = '<option>جاري التحميل...</option>';

    const snap = await db.ref(`configs/${currentStateId}/units`).once('value');
    const units = snap.val();

    unitSelect.innerHTML = '<option value="المتحكم الرئيسي">المتحكم الرئيسي</option>';
    if(units) {
        Object.keys(units).forEach(u => {
            unitSelect.innerHTML += `<option value="${u}">${u}</option>`;
        });
    }
}

async function login() {
    let state = document.getElementById("state-id").value;
    let user = document.getElementById("user-role").value;
    let pass = document.getElementById("pass-code").value;

    if(!state || !user) return Swal.fire("تنبيه", "يرجى اختيار الولاية والوحدة", "warning");

    const snap = await db.ref(`passwords/${state}/${user}`).once('value');
    const correctPass = snap.val() || "1111";

    if(pass === correctPass) {
        currentStateId = state;
        currentUser = user;
        document.getElementById("login-page").classList.add("hidden");
        document.getElementById("app-content").classList.remove("hidden");
        document.getElementById("display-state-name").innerText = `مديرية الحماية المدنية لولاية: ${algeriaStates[parseInt(state)-1]}`;
        document.getElementById("user-tag").innerText = currentUser;
        
        // جلب إعدادات الولاية (الوحدات والبلديات)
        const configSnap = await db.ref(`configs/${currentStateId}`).once('value');
        unitConfig = configSnap.val() || {};

        if(currentUser === "المتحكم الرئيسي" && !unitConfig.units) {
            document.getElementById("setup-section").classList.remove("hidden");
        }
        
        initSystem();
    } else {
        Swal.fire("خطأ", "كلمة المرور غير صحيحة", "error");
    }
}

async function setupStateConfig() {
    const { value: formValues } = await Swal.fire({
        title: 'تأسيس ولاية جديدة',
        html:
            '<p>أدخل أسماء الوحدات (فصل بينها بفاصلة ,)</p>' +
            '<input id="swal-units" class="swal2-input" placeholder="مثال: الرئيسية, قمار, الرباح">' +
            '<p>أدخل أسماء البلديات (فصل بينها بفاصلة ,)</p>' +
            '<input id="swal-munis" class="swal2-input" placeholder="مثال: الوادي, كوينين, البياضة">',
        focusConfirm: false,
        preConfirm: () => {
            return [
                document.getElementById('swal-units').value,
                document.getElementById('swal-munis').value
            ]
        }
    });

    if (formValues) {
        let unitsArr = formValues[0].split(',').map(s => s.trim());
        let munisArr = formValues[1].split(',').map(s => s.trim());
        
        let configObj = { units: {}, allMunis: munisArr };
        unitsArr.forEach(u => configObj.units[u] = []); // يمكن تطويرها لربط البلديات بالوحدات لاحقاً
        
        await db.ref(`configs/${currentStateId}`).set(configObj);
        Swal.fire("تم التأسيس", "يرجى إعادة تحميل الصفحة لتفعيل الإعدادات", "success").then(() => location.reload());
    }
}

function initSystem() {
    // هنا نضع دوال الـ Render و Calculate التي برمجناها سابقاً 
    // مع تعديل مسار الحفظ ليكون: db.ref(`data/${currentStateId}/${currentWeek}/${currentUser}`)
    console.log("النظام جاهز للعمل على ولاية: " + currentStateId);
}
</script>
</body>
</html>